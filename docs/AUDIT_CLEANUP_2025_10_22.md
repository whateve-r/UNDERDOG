# üîç Auditor√≠a y Limpieza del Proyecto UNDERDOG
**Fecha:** 22 de Octubre 2025  
**Objetivo:** Identificar y eliminar componentes obsoletos antes de migrar a TimescaleDB

---

## üìã Executive Summary

El proyecto UNDERDOG ha evolucionado a trav√©s de m√∫ltiples fases experimentales, dejando:
- **47 scripts** en `/scripts` (muchos de prueba/diagn√≥stico)
- **M√∫ltiples fuentes de datos obsoletas** (HuggingFace, Dukascopy, HistData)
- **Carpetas duplicadas** (`risk/` y `risk_management/`)
- **Configuraciones antiguas** (Lean, Streamlit, m√∫ltiples DBs)

**Estrategia Nueva:** Migrar a TimescaleDB con fuentes: yfinance, Alpha Vantage, Reddit, FRED (inspirado en AlphaQuanter)

---

## üóëÔ∏è COMPONENTES A ELIMINAR

### 1Ô∏è‚É£ **Scripts Obsoletos de Testing/Diagn√≥stico** (17 archivos)

#### Scripts de Diagn√≥stico ZMQ/MT5 (ya resueltos)
```
‚úó scripts/test_zmq_raw.py                  # Diagn√≥stico ZMQ - YA RESUELTO
‚úó scripts/test_zmq_dual.py                 # Test dual socket - YA RESUELTO
‚úó scripts/test_history_raw.py              # Test HISTORY raw - YA RESUELTO
‚úó scripts/test_history_count.py            # Test con COUNT - YA RESUELTO
‚úó scripts/test_history_full_output.py      # Test output completo - YA RESUELTO
‚úó scripts/test_history_data_first.py       # Test orden sockets - YA RESUELTO
‚úó scripts/diagnose_zmq_connection.py       # Diagn√≥stico completo ZMQ - YA RESUELTO
‚úó scripts/test_mt5_connection.py           # Test conexi√≥n MT5 - DUPLICADO de test_mt5_simple.py
```
**Raz√≥n:** Problemas ZMQ ya resueltos. `test_mt5_simple.py` y `test_mt5_historical_download.py` son suficientes.

#### Scripts de Testing de Librer√≠as Obsoletas
```
‚úó scripts/test_lean_install.py             # QuantConnect Lean - NO SE USA
‚úó scripts/test_lean_simple.py              # QuantConnect Lean - NO SE USA
‚úó scripts/test_hf_loader.py                # HuggingFace loader - SE REEMPLAZAR√Å
‚úó scripts/explore_hf_forex_datasets.py     # HuggingFace datasets - SE REEMPLAZAR√Å
```
**Raz√≥n:** Lean nunca se implement√≥. HuggingFace se reemplaza con yfinance/Alpha Vantage.

#### Scripts de Testing de Backtrader Duplicados
```
‚úó scripts/test_backtrader.py               # Test b√°sico - DUPLICADO
‚úó scripts/test_backtrader_simple.py        # Test simple - DUPLICADO
‚úó scripts/test_bt_minimal.py               # Test m√≠nimo - DUPLICADO
```
**Mantener:** `scripts/test_end_to_end.py` (test completo e2e con PropFirm rules)

#### Scripts de Testing de TA-Lib
```
‚úó scripts/test_talib_performance.py        # Performance test TA-Lib
```
**Raz√≥n:** TA-Lib validado y en producci√≥n. No necesitamos benchmark continuo.

#### Scripts de Testing Cient√≠ficos
```
‚úó scripts/test_scientific_improvements.py  # Test mejoras cient√≠ficas de Phase 3
```
**Raz√≥n:** Mejoras cient√≠ficas validadas e integradas en `bt_engine.py`.

---

### 2Ô∏è‚É£ **Fuentes de Datos Obsoletas** (6 archivos + carpetas)

#### Loaders de Datos Antiguos
```
‚úó underdog/data/hf_loader.py               # HuggingFace loader - SE REEMPLAZA
‚úó underdog/data/dukascopy_loader.py        # Dukascopy loader - SE REEMPLAZA
‚úó underdog/database/histdata_ingestion.py  # HistData ingestion - SE REEMPLAZA
```

#### Scripts de Descarga de Datos Antiguos
```
‚úó scripts/download_all_histdata.py         # HistData download - OBSOLETO
‚úó scripts/download_histdata_1min_only.py   # HistData M1 only - OBSOLETO
‚úó scripts/backfill_histdata_parquet.py     # HistData ‚Üí Parquet - OBSOLETO
‚úó scripts/backfill_all_data.py             # Backfill gen√©rico - OBSOLETO
‚úó scripts/setup_hf_token.py                # HuggingFace token setup - OBSOLETO
```

#### Carpetas de Datos Antiguos
```
‚úó data/raw/                                # HistData CSVs antiguos
‚úó data/historical/                         # Dukascopy/HF data cache
‚úó data/parquet/                            # Parquet cache antiguo (pre-TimescaleDB)
```

**Mantener:**
```
‚úì data/mt5_historical/                     # Cache de MT5 (datos reales broker)
‚úì data/processed/                          # Features procesados para ML
‚úì data/test_results/                       # Resultados de backtests
```

---

### 3Ô∏è‚É£ **Scripts de Configuraci√≥n/Setup Antiguos** (5 archivos)

```
‚úó scripts/setup_db_simple.ps1              # Setup PostgreSQL antiguo
‚úó scripts/setup_indicators_db.ps1          # Setup DB indicadores
‚úó scripts/setup_firewall_rules.ps1         # Firewall rules (espec√≠fico VPS anterior)
‚úó scripts/insert_indicators_to_db.py       # Insert indicadores ‚Üí DB antigua
‚úó scripts/resample_and_calculate.py        # Resample + calc indicadores ‚Üí DB antigua
```
**Raz√≥n:** Migraci√≥n a TimescaleDB requiere nuevos scripts de setup.

---

### 4Ô∏è‚É£ **Scripts de Demo/Integraci√≥n Incompletos** (5 archivos)

```
‚úó scripts/demo_paper_trading.py            # Demo paper trading - INCOMPLETO (bloqueado por MT5Executor refactor)
‚úó scripts/complete_trading_workflow.py     # Workflow completo - INCOMPLETO
‚úó scripts/integrated_trading_system.py     # Sistema integrado - INCOMPLETO
‚úó scripts/integration_test.py              # Test integraci√≥n - SUPERSEDED por test_end_to_end.py
‚úó scripts/start_live.py                    # Start live trading - INCOMPLETO
```
**Raz√≥n:** Workflows incompletos reemplazados por `start_trading_with_monitoring.py` (m√°s completo).

---

### 5Ô∏è‚É£ **Scripts de Monitoring/Prometheus Antiguos** (3 archivos)

```
‚úó scripts/instrument_eas_prometheus.py     # Instrumentaci√≥n EAs - OBSOLETO (JsonAPI EA no tiene esto)
‚úó scripts/generate_test_metrics.py         # Generar m√©tricas test - OBSOLETO
‚úó scripts/start_metrics.ps1                # Start Prometheus - REEMPLAZAR con docker-compose
```
**Mantener:** `scripts/monitoring_example.py` (ejemplo funcional)

---

### 6Ô∏è‚É£ **Scripts de ML/Preprocessing Antiguos** (3 archivos)

```
‚úó scripts/ml_preprocessing_example.py      # Ejemplo preprocessing - INCOMPLETO
‚úó scripts/retrain_models.py                # Retrain ML models - INCOMPLETO
‚úó scripts/generate_synthetic_data.py       # Generate synthetic data - NO SE USA (backtest usa synthetic inline)
```
**Raz√≥n:** ML pipeline incompleto. Con nueva arquitectura TimescaleDB + AlphaQuanter, necesitaremos reescribir.

---

### 7Ô∏è‚É£ **Scripts de Descarga √çndices/Pares** (2 archivos)

```
‚úó scripts/download_indices.py              # Download √≠ndices econ√≥micos - SE REEMPLAZA con FRED
‚úó scripts/download_liquid_pairs.py         # Download pares l√≠quidos - SE REEMPLAZA con yfinance
```

---

### 8Ô∏è‚É£ **Carpetas/M√≥dulos Duplicados**

```
‚úó underdog/risk/                           # DUPLICADO de underdog/risk_management/
```
**Acci√≥n:** Consolidar en `underdog/risk_management/` (m√°s espec√≠fico).

---

### 9Ô∏è‚É£ **UI Streamlit Obsoleto**

```
‚úó scripts/streamlit_dashboard.py          # Streamlit UI - NO SE USA (preferimos Grafana)
‚úó underdog/ui/                             # M√≥dulo UI incompleto
```
**Raz√≥n:** Grafana es mejor para monitoreo 24/7. Streamlit es para exploraci√≥n, no producci√≥n.

---

### üîü **Scripts de Start Incompletos**

```
‚úó scripts/start_backtest.py               # Start backtest - SUPERSEDED por test_end_to_end.py
```
**Mantener:** `scripts/start_trading_with_monitoring.py` (√∫nico script de start completo).

---

## ‚úÖ COMPONENTES A MANTENER (Core del Sistema)

### Scripts Esenciales (8 archivos)
```
‚úì scripts/test_mt5_simple.py               # Test conexi√≥n MT5 ZMQ (producci√≥n)
‚úì scripts/test_mt5_historical_download.py  # Test descarga datos MT5 (producci√≥n)
‚úì scripts/test_end_to_end.py               # Test e2e backtest con PropFirm rules
‚úì scripts/start_trading_with_monitoring.py # Sistema completo live + monitoring
‚úì scripts/monitoring_example.py            # Ejemplo Prometheus/Grafana
‚úì scripts/desc.py                          # Utilidad descripci√≥n (?)
```

### Core del Sistema (`underdog/`)
```
‚úì underdog/backtesting/                    # Backtrader engine + adaptadores
  ‚úì bt_engine.py                           # Backtesting engine (PRODUCTION READY)
  ‚úì bt_adapter.py                          # Backtrader ‚Üí internal adapter
  
‚úì underdog/bridges/                        # Bridges estrategias
  ‚úì bt_to_mt5.py                           # Backtrader ‚Üí MT5 bridge (PRODUCTION READY)
  
‚úì underdog/core/                           # Core abstracciones
  ‚úì connectors/mt5_connector.py            # MT5 ZMQ connector (PRODUCTION READY)
  ‚úì schemas/                               # Schemas Pydantic
  ‚úì abstractions.py                        # Base classes
  ‚úì logger.py                              # Logging system
  
‚úì underdog/data/                           # Data handlers
  ‚úì mt5_historical_loader.py               # MT5 historical data (PRODUCTION READY)
  
‚úì underdog/execution/                      # Execution layer
  ‚úì mt5_executor.py                        # MT5 order executor (NEEDS REFACTOR to use mt5_connector.py)
  
‚úì underdog/risk_management/                # Risk management
  ‚úì propfirm_risk.py                       # PropFirm rules (FTMO/FTUK) (PRODUCTION READY)
  
‚úì underdog/strategies/                     # Trading strategies
  ‚úì atr_breakout.py                        # ATR Breakout strategy (PRODUCTION READY)
  
‚úì underdog/monitoring/                     # Monitoring
  ‚úì prometheus_metrics.py                  # Prometheus instrumentation
  
‚úì underdog/validation/                     # Validation
  ‚úì monte_carlo.py                         # Monte Carlo simulation (PRODUCTION READY)
```

---

## üì¶ PLAN DE MIGRACI√ìN A TimescaleDB

### Nuevas Fuentes de Datos (inspirado en AlphaQuanter)
```
1. yfinance          ‚Üí Precios hist√≥ricos (OHLCV)
2. Alpha Vantage     ‚Üí Datos fundamentales + econ√≥micos
3. Reddit API        ‚Üí Sentiment analysis (r/wallstreetbets, r/stocks)
4. FRED API          ‚Üí Indicadores macroecon√≥micos (Fed Reserve)
```

### Nueva Arquitectura de Datos
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                       TimescaleDB                            ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  Hypertable: ohlcv_data (time, symbol, open, high, low...)  ‚îÇ
‚îÇ  Hypertable: reddit_sentiment (time, subreddit, score...)   ‚îÇ
‚îÇ  Hypertable: fred_indicators (time, indicator, value...)    ‚îÇ
‚îÇ  Table: alpha_vantage_fundamentals (company, pe, ...)       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚Üë                    ‚Üë                    ‚Üë
         ‚îÇ                    ‚îÇ                    ‚îÇ
    yfinance           Reddit API           FRED API
    backfill           scraper              backfill
```

### Scripts Nuevos a Crear
```
‚ñ° scripts/setup_timescaledb.py              # Setup TimescaleDB hypertables
‚ñ° scripts/backfill_yfinance.py              # Backfill desde yfinance
‚ñ° scripts/backfill_fred.py                  # Backfill FRED indicators
‚ñ° scripts/backfill_reddit.py                # Backfill Reddit sentiment
‚ñ° underdog/data/timescale_loader.py         # TimescaleDB data loader
‚ñ° underdog/data/yfinance_ingestion.py       # yfinance ‚Üí TimescaleDB
‚ñ° underdog/data/fred_ingestion.py           # FRED ‚Üí TimescaleDB
‚ñ° underdog/data/reddit_ingestion.py         # Reddit ‚Üí TimescaleDB
```

---

## üéØ ACCI√ìN RECOMENDADA

### Fase 1: Limpieza Inmediata (10 min)
```bash
# Eliminar scripts de diagn√≥stico ZMQ resueltos
rm scripts/test_zmq_*.py
rm scripts/test_history_*.py
rm scripts/diagnose_zmq_connection.py
rm scripts/test_mt5_connection.py

# Eliminar scripts de testing duplicados
rm scripts/test_backtrader*.py
rm scripts/test_bt_minimal.py
rm scripts/test_talib_performance.py
rm scripts/test_scientific_improvements.py

# Eliminar loaders antiguos de datos
rm scripts/download_all_histdata.py
rm scripts/download_histdata_1min_only.py
rm scripts/backfill_*.py
rm scripts/setup_hf_token.py
rm scripts/test_hf_loader.py
rm scripts/explore_hf_forex_datasets.py

# Eliminar scripts de setup antiguos
rm scripts/setup_db_simple.ps1
rm scripts/setup_indicators_db.ps1
rm scripts/setup_firewall_rules.ps1
rm scripts/insert_indicators_to_db.py
rm scripts/resample_and_calculate.py

# Eliminar demos incompletos
rm scripts/demo_paper_trading.py
rm scripts/complete_trading_workflow.py
rm scripts/integrated_trading_system.py
rm scripts/integration_test.py
rm scripts/start_live.py
rm scripts/start_backtest.py

# Eliminar monitoring antiguo
rm scripts/instrument_eas_prometheus.py
rm scripts/generate_test_metrics.py
rm scripts/start_metrics.ps1

# Eliminar ML incompleto
rm scripts/ml_preprocessing_example.py
rm scripts/retrain_models.py
rm scripts/generate_synthetic_data.py

# Eliminar descarga √≠ndices antiguos
rm scripts/download_indices.py
rm scripts/download_liquid_pairs.py

# Eliminar UI Streamlit
rm scripts/streamlit_dashboard.py

# Eliminar tests de Lean
rm scripts/test_lean_*.py
```

### Fase 2: Limpieza de M√≥dulos (5 min)
```bash
# Eliminar loaders de datos antiguos
rm underdog/data/hf_loader.py
rm underdog/data/dukascopy_loader.py
rm underdog/database/histdata_ingestion.py

# Consolidar risk management
mv underdog/risk_management/* underdog/risk/
rmdir underdog/risk_management

# Eliminar UI incompleto
rm -rf underdog/ui/
```

### Fase 3: Limpieza de Datos (5 min)
```bash
# Eliminar carpetas de datos antiguos (CUIDADO: backup primero si hay algo importante)
rm -rf data/raw/
rm -rf data/historical/
rm -rf data/parquet/

# Mantener:
# - data/mt5_historical/ (cache MT5 real broker)
# - data/processed/ (features ML)
# - data/test_results/ (resultados backtests)
```

### Fase 4: Actualizar Imports (5 min)
```python
# underdog/data/__init__.py
# ANTES:
from underdog.data.hf_loader import HuggingFaceDataHandler, ForexNewsHandler
__all__ = ['HuggingFaceDataHandler', 'ForexNewsHandler']

# DESPU√âS:
from underdog.data.mt5_historical_loader import MT5HistoricalDataLoader
__all__ = ['MT5HistoricalDataLoader']
```

```python
# underdog/backtesting/bt_engine.py
# ELIMINAR imports de HuggingFace:
# from underdog.data.hf_loader import HuggingFaceDataHandler

# MANTENER:
# - Synthetic data generation (inline)
# - MT5HistoricalDataLoader para datos reales
```

---

## üìä RESUMEN DE LIMPIEZA

| Categor√≠a | Archivos a Eliminar | Raz√≥n |
|-----------|---------------------|-------|
| Scripts diagn√≥stico ZMQ | 8 | Problemas resueltos |
| Scripts testing duplicados | 6 | Test e2e suficiente |
| Loaders datos antiguos | 9 | Migraci√≥n a TimescaleDB |
| Scripts setup antiguos | 5 | Nueva arquitectura DB |
| Demos incompletos | 6 | Reemplazados |
| Monitoring antiguo | 3 | Docker + Grafana |
| ML incompleto | 3 | Pipeline nuevo |
| Descarga datos antiguo | 2 | yfinance/FRED |
| UI Streamlit | 2 | Grafana preferido |
| Tests Lean | 2 | Nunca usado |
| **TOTAL** | **46 archivos** | |

### Reducci√≥n de Scripts: 47 ‚Üí **8 esenciales** (83% reducci√≥n)

---

## üöÄ PR√ìXIMOS PASOS

1. ‚úÖ **Limpieza** (este documento)
2. ‚ñ° **Setup TimescaleDB** local (Docker)
3. ‚ñ° **Crear backfill yfinance** (OHLCV hist√≥rico)
4. ‚ñ° **Crear backfill FRED** (indicadores macro)
5. ‚ñ° **Crear backfill Reddit** (sentiment)
6. ‚ñ° **Integrar Alpha Vantage** (fundamentals)
7. ‚ñ° **Actualizar bt_engine.py** para usar TimescaleDB
8. ‚ñ° **Refactor MT5Executor** para usar mt5_connector.py
9. ‚ñ° **Implementar continuous trading loop** (Task 2 en todo list)
10. ‚ñ° **Deploy VPS** con TimescaleDB + Grafana

---

## üìö Referencias
- AlphaQuanter: https://github.com/AlphaQuanter/AlphaQuanter
- TimescaleDB Docs: https://docs.timescale.com/
- yfinance: https://github.com/ranaroussi/yfinance
- FRED API: https://fred.stlouisfed.org/docs/api/
- Alpha Vantage: https://www.alphavantage.co/documentation/

---

**Autor:** GitHub Copilot  
**Reviewed by:** User (manud)  
**Status:** READY FOR EXECUTION
